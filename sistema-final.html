<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia Final - Colegio</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }

        .admin-panel { 
            background: #e8f4fd; 
            border-left: 4px solid var(--primary); 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px;
        }
        
        .schedule-block { 
            background: #f8f9fa; 
            border-left: 4px solid var(--primary); 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px;
        }
        
        .day-tabs { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 15px; 
            overflow-x: auto;
        }
        
        .day-tab { 
            padding: 10px 15px; 
            background: #ecf0f1; 
            border-radius: 5px; 
            cursor: pointer;
            min-width: 80px;
            text-align: center;
            white-space: nowrap;
        }
        
        .day-tab.active { 
            background: var(--primary); 
            color: white; 
        }
        
        .class-card { 
            background: white; 
            border: 2px solid #e9ecef; 
            padding: 15px; 
            margin: 10px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .class-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .attendance-record {
            background: #e8f5e8;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid var(--secondary);
        }
        
        .time-badge {
            background: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 0 5px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .data-table th {
            background: var(--dark);
            color: white;
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .teacher-form {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .status-puntual { background: #d4edda; color: #155724; }
        .status-tardio { background: #fff3cd; color: #856404; }
        .status-ausente { background: #f8d7da; color: #721c24; }
        
        .logout-btn {
            background: var(--danger) !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">üè´ Cargando Sistema de Asistencia Final...</div>
    </div>

    <script>
        // SISTEMA FINAL - CON TODAS LAS FUNCIONALIDADES COMPLETAS
        class FinalAttendanceSystem {
            constructor() {
                this.currentUser = null;
                this.currentDay = this.getCurrentDay();
                this.currentView = 'login';
                this.adminPassword = "admin123"; // Contrase√±a modificable
                
                this.loadAllData();
                this.init();
            }

            getCurrentDay() {
                const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                return days[new Date().getDay()];
            }

            loadAllData() {
                // Cargar contrase√±a admin
                this.adminPassword = localStorage.getItem('admin_password') || "admin123";
                
                // Maestros - lista completamente editable
                this.teachers = JSON.parse(localStorage.getItem('final_teachers')) || this.getDefaultTeachers();
                
                // Horario semanal FLEXIBLE - per√≠odos indefinidos
                this.weeklySchedule = JSON.parse(localStorage.getItem('final_schedule')) || this.initializeFlexibleSchedule();
                
                // Registros de asistencia
                this.attendanceRecords = JSON.parse(localStorage.getItem('final_attendance')) || [];
                
                // Cat√°logos editables
                this.subjects = JSON.parse(localStorage.getItem('final_subjects')) || [
                    "Matem√°ticas", "Lenguaje", "Ciencias", "Historia", "Psicolog√≠a", 
                    "F√≠sica", "Qu√≠mica", "Biolog√≠a", "Educaci√≥n F√≠sica", "Arte", "Ingl√©s"
                ];
                
                this.grades = JSON.parse(localStorage.getItem('final_grades')) || [
                    "1ro Secundaria", "2do Secundaria", "3ro Secundaria", 
                    "4to Secundaria", "5to Secundaria"
                ];
                
                this.classrooms = JSON.parse(localStorage.getItem('final_classrooms')) || [
                    "Aula 101", "Aula 102", "Aula 103", "Laboratorio", "Sala de Computo", "Cancha"
                ];
            }

            getDefaultTeachers() {
                return [
                    {
                        id: 1,
                        name: "Prof. Gabriel Mart√≠nez",
                        email: "gabriel@colegio.edu",
                        phone: "123-456-7890",
                        avatar: "GM",
                        subjects: ["Matem√°ticas", "Psicolog√≠a"],
                        active: true
                    },
                    {
                        id: 2,
                        name: "Prof. Ana L√≥pez", 
                        email: "ana@colegio.edu",
                        phone: "123-456-7891",
                        avatar: "AL",
                        subjects: ["Lenguaje", "Historia"],
                        active: true
                    }
                ];
            }

            initializeFlexibleSchedule() {
                return {
                    "Lunes": [
                        {
                            id: 1,
                            teacherId: 1,
                            startTime: "13:00",
                            endTime: "13:40",
                            subject: "Matem√°ticas",
                            grade: "4to Secundaria",
                            classroom: "Aula 101",
                            course: "4A"
                        },
                        {
                            id: 2,
                            teacherId: 1, 
                            startTime: "13:40",
                            endTime: "14:20",
                            subject: "Psicolog√≠a",
                            grade: "3ro Secundaria", 
                            classroom: "Aula 102",
                            course: "3B"
                        }
                    ],
                    "Martes": [
                        {
                            id: 3,
                            teacherId: 1,
                            startTime: "14:20",
                            endTime: "15:00", 
                            subject: "Matem√°ticas",
                            grade: "5to Secundaria",
                            classroom: "Aula 103",
                            course: "5A"
                        }
                    ],
                    "Mi√©rcoles": [],
                    "Jueves": [],
                    "Viernes": [],
                    "S√°bado": []
                };
            }

            saveAllData() {
                localStorage.setItem('admin_password', this.adminPassword);
                localStorage.setItem('final_teachers', JSON.stringify(this.teachers));
                localStorage.setItem('final_schedule', JSON.stringify(this.weeklySchedule));
                localStorage.setItem('final_attendance', JSON.stringify(this.attendanceRecords));
                localStorage.setItem('final_subjects', JSON.stringify(this.subjects));
                localStorage.setItem('final_grades', JSON.stringify(this.grades));
                localStorage.setItem('final_classrooms', JSON.stringify(this.classrooms));
            }

            init() {
                this.showLogin();
            }

            // ==================== SISTEMA DE LOGIN MEJORADO ====================
            showLogin() {
                this.currentView = 'login';
                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>üè´ Sistema de Asistencia Final</h1>
                        <p>Gesti√≥n completa con horarios flexibles y panel administrativo</p>
                    </div>
                    
                    <div class="container">
                        <div class="card">
                            <h2>üîê Iniciar Sesi√≥n como Administrador</h2>
                            <div class="form-group">
                                <label>Usuario:</label>
                                <input type="text" id="username" value="admin" readonly style="background: #f8f9fa;">
                            </div>
                            <div class="form-group">
                                <label>Contrase√±a:</label>
                                <input type="password" id="password" placeholder="Ingresa la contrase√±a">
                            </div>
                            <button class="btn btn-primary" onclick="finalApp.login()">
                                üéØ Ingresar al Sistema
                            </button>
                            <div style="text-align: center; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <small><strong>Usuario:</strong> admin | <strong>Contrase√±a actual:</strong> ${this.adminPassword}</small>
                            </div>
                        </div>
                    </div>
                `;
            }

            login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (username === 'admin' && password === this.adminPassword) {
                    this.currentUser = { username, role: 'admin' };
                    this.showMainDashboard();
                } else {
                    alert('‚ùå Contrase√±a incorrecta. Contacta al administrador.');
                }
            }

            // ==================== DASHBOARD PRINCIPAL ====================
            showMainDashboard() {
                this.currentView = 'dashboard';
                const todaysClasses = this.getTodaysClasses();
                const todaysRecords = this.getTodaysRecords();
                
                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>üìä Panel Principal - ${this.currentDay}</h1>
                        <p>${new Date().toLocaleDateString('es-ES')} - Sistema de Gesti√≥n Completa</p>
                    </div>
                    
                    <div class="container">
                        <!-- Selector de d√≠a -->
                        <div class="card">
                            <h3>üìÖ Seleccionar D√≠a para Gesti√≥n</h3>
                            <div class="day-tabs">
                                ${['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'].map(day => `
                                    <div class="day-tab ${day === this.currentDay ? 'active' : ''}" 
                                         onclick="finalApp.changeCurrentDay('${day}')">
                                        ${day}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Resumen del d√≠a -->
                        <div class="card">
                            <h3>üìà Resumen de ${this.currentDay}</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                <div style="text-align: center; padding: 15px; background: #e8f4fd; border-radius: 5px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #3498db;">${todaysClasses.length}</div>
                                    <div>Clases Programadas</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 5px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${todaysRecords.length}</div>
                                    <div>Registros Completados</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 5px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${this.teachers.length}</div>
                                    <div>Maestros Activos</div>
                                </div>
                            </div>
                        </div>

                        <!-- Acciones principales -->
                        <div class="card">
                            <h3>üöÄ M√≥dulos del Sistema</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <button class="btn btn-primary" onclick="finalApp.showAttendanceModule()">
                                    üìù Registro de Asistencia
                                </button>
                                <button class="btn btn-success" onclick="finalApp.showScheduleManager()">
                                    üóìÔ∏è Gestor de Horarios
                                </button>
                                <button class="btn btn-warning" onclick="finalApp.showTeachersManager()">
                                    üë®‚Äçüè´ Gesti√≥n de Maestros
                                </button>
                                <button class="btn" onclick="finalApp.showReportsModule()" style="background: #9b59b6; color: white;">
                                    üìä Reportes y Tablas
                                </button>
                                <button class="btn" onclick="finalApp.showAdminSettings()" style="background: #e67e22; color: white;">
                                    ‚öôÔ∏è Configuraci√≥n
                                </button>
                                <button class="btn logout-btn" onclick="finalApp.logout()">
                                    üö™ Cerrar Sesi√≥n
                                </button>
                            </div>
                        </div>

                        <!-- Clases de hoy -->
                        ${todaysClasses.length > 0 ? `
                        <div class="card">
                            <h3>üìö Clases de ${this.currentDay}</h3>
                            ${todaysClasses.map(cls => {
                                const teacher = this.teachers.find(t => t.id === cls.teacherId);
                                const record = todaysRecords.find(r => r.scheduleId === cls.id);
                                return `
                                    <div class="class-card">
                                        <div style="display: flex; justify-content: between; align-items: start;">
                                            <div style="flex: 1;">
                                                <h4>${cls.subject} - ${cls.grade}</h4>
                                                <p>
                                                    <strong>Profesor:</strong> ${teacher?.name}<br>
                                                    <strong>Horario:</strong> ${cls.startTime} - ${cls.endTime}<br>
                                                    <strong>Aula:</strong> ${cls.classroom}
                                                </p>
                                            </div>
                                            <div style="text-align: right;">
                                                ${record ? `
                                                    <div class="attendance-record">
                                                        <div>‚úÖ Registrado</div>
                                                        <small>Entrada: ${record.entryTime}</small>
                                                        ${record.exitTime ? `<br><small>Salida: ${record.exitTime}</small>` : ''}
                                                    </div>
                                                ` : `
                                                    <button class="btn btn-primary" onclick="finalApp.showAttendanceModule()">
                                                        Registrar
                                                    </button>
                                                `}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            changeCurrentDay(day) {
                this.currentDay = day;
                this.showMainDashboard();
            }

            // ==================== M√ìDULO DE ASISTENCIA COMPLETO ====================
            showAttendanceModule() {
                const todaysClasses = this.getTodaysClasses();
                const currentTime = this.getCurrentTime();
                
                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>üìù Registro de Asistencia - ${this.currentDay}</h1>
                        <div>
                            <button class="btn" onclick="finalApp.showMainDashboard()">‚Üê Dashboard</button>
                            <span class="time-badge">üïê ${currentTime}</span>
                        </div>
                    </div>
                    
                    <div class="container">
                        <!-- Informaci√≥n de hora -->
                        <div class="card">
                            <h3>üïê Control de Tiempo</h3>
                            <div style="text-align: center; padding: 20px; background: #e8f5e8; border-radius: 10px;">
                                <div style="font-size: 32px; font-weight: bold; color: #27ae60;" id="currentTimeDisplay">${currentTime}</div>
                                <p style="margin: 10px 0; color: #7f8c8d;">
                                    <small>Hora autom√°tica del sistema - Anti-fraude</small>
                                </p>
                                <button class="btn btn-success" onclick="finalApp.updateTimeDisplay()">
                                    üîÑ Actualizar Hora
                                </button>
                            </div>
                        </div>

                        <!-- Registro de clases -->
                        <div class="card">
                            <h3>üìö Clases de ${this.currentDay}</h3>
                            ${todaysClasses.length > 0 ? 
                                todaysClasses.map(cls => {
                                    const teacher = this.teachers.find(t => t.id === cls.teacherId);
                                    const record = this.getTodaysRecords().find(r => r.scheduleId === cls.id);
                                    
                                    return `
                                        <div class="class-card">
                                            <h4>${cls.subject} - ${cls.grade} (${cls.course})</h4>
                                            <p>
                                                <strong>Profesor:</strong> ${teacher?.name}<br>
                                                <strong>Horario:</strong> ${cls.startTime} - ${cls.endTime}<br>
                                                <strong>Aula:</strong> ${cls.classroom}
                                            </p>
                                            
                                            ${!record ? `
                                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                                    <button class="btn btn-primary" onclick="finalApp.registerClassEntry(${cls.id})">
                                                        ‚úÖ Registrar Entrada
                                                    </button>
                                                </div>
                                            ` : !record.exitTime ? `
                                                <div class="attendance-record">
                                                    <div>üü° Clase en progreso</div>
                                                    <small>Entrada registrada: ${record.entryTime}</small>
                                                    <div style="margin-top: 10px;">
                                                        <button class="btn btn-success" onclick="finalApp.registerClassExit(${cls.id})">
                                                            üèÅ Registrar Salida
                                                        </button>
                                                    </div>
                                                </div>
                                            ` : `
                                                <div class="attendance-record">
                                                    <div>‚úÖ Clase completada</div>
                                                    <small>Entrada: ${record.entryTime} | Salida: ${record.exitTime}</small>
                                                    <div style="margin-top: 5px;">
                                                        <span class="status-badge status-${record.status.toLowerCase()}">
                                                            ${record.status}
                                                        </span>
                                                    </div>
                                                </div>
                                            `}
                                        </div>
                                    `;
                                }).join('') 
                                : '<div class="schedule-block"><p>No hay clases programadas para este d√≠a.</p></div>'
                            }
                        </div>
                    </div>
                `;

                this.startTimeAutoUpdate();
            }

            registerClassEntry(scheduleId) {
                const schedule = this.getScheduleById(scheduleId);
                const teacher = this.teachers.find(t => t.id === schedule.teacherId);
                const currentTime = this.getCurrentTime();
                const status = this.calculateStatus(currentTime, schedule.startTime);
                
                const newRecord = {
                    id: Date.now(),
                    scheduleId: scheduleId,
                    teacherId: schedule.teacherId,
                    teacherName: teacher.name,
                    date: new Date().toLocaleDateString(),
                    day: this.currentDay,
                    startTime: schedule.startTime,
                    endTime: schedule.endTime,
                    subject: schedule.subject,
                    grade: schedule.grade,
                    course: schedule.course,
                    classroom: schedule.classroom,
                    entryTime: currentTime,
                    exitTime: null,
                    status: status,
                    registeredBy: this.currentUser.username,
                    registeredAt: new Date().toISOString()
                };

                this.attendanceRecords.push(newRecord);
                this.saveAllData();
                
                alert(`‚úÖ Entrada registrada:\n\n` +
                      `Profesor: ${teacher.name}\n` +
                      `Clase: ${schedule.subject} - ${schedule.grade}\n` +
                      `Hora de entrada: ${currentTime}\n` +
                      `Estado: ${status}`);
                
                this.showAttendanceModule();
            }

            registerClassExit(scheduleId) {
                const record = this.getTodaysRecords().find(r => r.scheduleId === scheduleId);
                if (!record) return;
                
                const currentTime = this.getCurrentTime();
                record.exitTime = currentTime;
                record.completed = true;
                
                this.saveAllData();
                
                alert(`‚úÖ Salida registrada:\n\n` +
                      `Profesor: ${record.teacherName}\n` +
                      `Clase: ${record.subject} - ${record.grade}\n` +
                      `Hora de salida: ${currentTime}\n` +
                      `Duraci√≥n: ${this.calculateDuration(record.entryTime, currentTime)}`);
                
                this.showAttendanceModule();
            }

            // ==================== GESTI√ìN DE HORARIOS FLEXIBLES ====================
            showScheduleManager() {
                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>üóìÔ∏è Gestor de Horarios Flexibles</h1>
                        <button class="btn" onclick="finalApp.showMainDashboard()">‚Üê Dashboard</button>
                    </div>
                    
                    <div class="container">
                        <!-- Formulario para agregar clase -->
                        <div class="card admin-panel">
                            <h3>‚ûï Agregar Nueva Clase al Horario</h3>
                            <div class="teacher-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>D√≠a de la semana:</label>
                                        <select id="newClassDay">
                                            <option value="Lunes">Lunes</option>
                                            <option value="Martes">Martes</option>
                                            <option value="Mi√©rcoles">Mi√©rcoles</option>
                                            <option value="Jueves">Jueves</option>
                                            <option value="Viernes">Viernes</option>
                                            <option value="S√°bado">S√°bado</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Profesor:</label>
                                        <select id="newClassTeacher">
                                            ${this.teachers.filter(t => t.active).map(t => 
                                                `<option value="${t.id}">${t.name}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Hora de inicio:</label>
                                        <input type="time" id="newClassStart" value="13:00">
                                    </div>
                                    <div class="form-group">
                                        <label>Hora de fin:</label>
                                        <input type="time" id="newClassEnd" value="13:40">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Asignatura:</label>
                                        <input type="text" id="newClassSubject" placeholder="Matem√°ticas" list="subjectsList">
                                        <datalist id="subjectsList">
                                            ${this.subjects.map(s => `<option value="${s}">`).join('')}
                                        </datalist>
                                    </div>
                                    <div class="form-group">
                                        <label>Grado:</label>
                                        <input type="text" id="newClassGrade" placeholder="4to Secundaria" list="gradesList">
                                        <datalist id="gradesList">
                                            ${this.grades.map(g => `<option value="${g}">`).join('')}
                                        </datalist>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Curso/Secci√≥n:</label>
                                        <input type="text" id="newClassCourse" placeholder="4A" value="4A">
                                    </div>
                                    <div class="form-group">
                                        <label>Aula:</label>
                                        <input type="text" id="newClassClassroom" placeholder="Aula 101" list="classroomsList">
                                        <datalist id="classroomsList">
                                            ${this.classrooms.map(c => `<option value="${c}">`).join('')}
                                        </datalist>
                                    </div>
                                </div>
                                
                                <button class="btn btn-success" onclick="finalApp.addNewClass()">
                                    ‚ûï Agregar Clase al Horario
                                </button>
                            </div>
                        </div>

                        <!-- Horario semanal -->
                        <div class="card">
                            <h3>üìÖ Horario Semanal Completo</h3>
                            <div class="day-tabs">
                                ${['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'].map(day => `
                                    <div class="day-tab ${day === this.currentDay ? 'active' : ''}" 
                                         onclick="finalApp.showDaySchedule('${day}')">
                                        ${day}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div id="dayScheduleContent">
                                ${this.renderDaySchedule(this.currentDay)}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderDaySchedule(day) {
                const daySchedule = this.weeklySchedule[day] || [];
                return daySchedule.length > 0 ? 
                    daySchedule.map(cls => {
                        const teacher = this.teachers.find(t => t.id === cls.teacherId);
                        return `
                            <div class="schedule-block">
                                <div style="display: flex; justify-content: between; align-items: center;">
                                    <div style="flex: 1;">
                                        <h4>${cls.subject} - ${cls.grade} (${cls.course})</h4>
                                        <p>
                                            <strong>Profesor:</strong> ${teacher?.name}<br>
                                            <strong>Horario:</strong> ${cls.startTime} - ${cls.endTime}<br>
                                            <strong>Aula:</strong> ${cls.classroom}
                                        </p>
                                    </div>
                                    <div>
                                        <button class="btn" onclick="finalApp.editClass('${day}', ${cls.id})" 
                                                style="background: #f39c12; color: white; padding: 5px 10px; margin: 2px;">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn" onclick="finalApp.deleteClass('${day}', ${cls.id})" 
                                                style="background: #e74c3c; color: white; padding: 5px 10px; margin: 2px;">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('') 
                    : `<div class="schedule-block"><p>No hay clases programadas para ${day}.</p></div>`;
            }

            showDaySchedule(day) {
                document.getElementById('dayScheduleContent').innerHTML = this.renderDaySchedule(day);
                document.querySelectorAll('.day-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.textContent === day);
                });
            }

            addNewClass() {
                const day = document.getElementById('newClassDay').value;
                const teacherId = parseInt(document.getElementById('newClassTeacher').value);
                const startTime = document.getElementById('newClassStart').value;
                const endTime = document.getElementById('newClassEnd').value;
                const subject = document.getElementById('newClassSubject').value;
                const grade = document.getElementById('newClassGrade').value;
                const course = document.getElementById('newClassCourse').value;
                const classroom = document.getElementById('newClassClassroom').value;

                if (!day || !teacherId || !startTime || !endTime || !subject || !grade || !course) {
                    alert('Por favor complete todos los campos obligatorios');
                    return;
                }

                if (!this.weeklySchedule[day]) {
                    this.weeklySchedule[day] = [];
                }

                const newClass = {
                    id: Date.now(),
                    teacherId: teacherId,
                    startTime: startTime,
                    endTime: endTime,
                    subject: subject,
                    grade: grade,
                    course: course,
                    classroom: classroom
                };

                this.weeklySchedule[day].push(newClass);
                this.weeklySchedule[day].sort((a, b) => a.startTime.localeCompare(b.startTime));
                
                this.saveAllData();
                alert(`‚úÖ Clase agregada al horario de ${day}`);
                this.showDaySchedule(day);
            }

            deleteClass(day, classId) {
                if (confirm('¬øEst√° seguro de eliminar esta clase del horario?')) {
                    this.weeklySchedule[day] = this.weeklySchedule[day].filter(cls => cls.id !== classId);
                    this.saveAllData();
                    this.showDaySchedule(day);
                }
            }

            // ==================== GESTI√ìN DE MAESTROS ====================
            showTeachersManager() {
                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>üë®‚Äçüè´ Gesti√≥n Completa de Maestros</h1>
                        <button class="btn" onclick="finalApp.showMainDashboard()">‚Üê Dashboard</button>
                    </div>
                    
                    <div class="container">
                        <!-- Formulario para agregar maestro -->
                        <div class="card admin-panel">
                            <h3>‚ûï Agregar Nuevo Maestro</h3>
                            <div class="teacher-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Nombre completo:</label>
                                        <input type="text" id="newTeacherName" placeholder="Ej: Prof. Mar√≠a Gonz√°lez">
                                    </div>
                                    <div class="form-group">
                                        <label>Correo electr√≥nico:</label>
                                        <input type="email" id="newTeacherEmail" placeholder="ejemplo@colegio.edu">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Tel√©fono:</label>
                                        <input type="text" id="newTeacherPhone" placeholder="123-456-7890">
                                    </div>
                                    <div class="form-group">
                                        <label>Materias que ense√±a:</label>
                                        <input type="text" id="newTeacherSubjects" placeholder="Matem√°ticas, F√≠sica">
                                    </div>
                                </div>
                                
                                <button class="btn btn-success" onclick="finalApp.addNewTeacher()">
                                    ‚ûï Agregar Maestro
                                </button>
                            </div>
                        </div>

                        <!-- Lista de maestros -->
                        <div class="card">
                            <h3>üìã Lista de Maestros (${this.teachers.length})</h3>
                            ${this.teachers.map(teacher => {
                                const teacherClasses = this.getTeacherClasses(teacher.id);
                                return `
                                    <div class="schedule-block">
                                        <div style="display: flex; justify-content: between; align-items: start;">
                                            <div style="flex: 1;">
                                                <h4>${teacher.name}</h4>
                                                <p>üìß ${teacher.email} ‚Ä¢ üìû ${teacher.phone}</p>
                                                <p><strong>Materias:</strong> ${teacher.subjects?.join(', ') || 'No asignadas'}</p>
                                                <p><strong>Clases asignadas:</strong> ${teacherClasses.length}</p>
                                            </div>
                                            <div>
                                                <button class="btn" onclick="finalApp.editTeacher(${teacher.id})" 
                                                        style="background: #f39c12; color: white; padding: 5px 10px; margin: 2px;">
                                                    ‚úèÔ∏è Editar
                                                </button>
                                                ${teacherClasses.length === 0 ? `
                                                    <button class="btn" onclick="finalApp.deleteTeacher(${teacher.id})" 
                                                            style="background: #e74c3c; color: white; padding: 5px 10px; margin: 2px;">
                                                        üóëÔ∏è Eliminar
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            addNewTeacher() {
                const name = document.getElementById('newTeacherName').value;
                const email = document.getElementById('newTeacherEmail').value;
                const phone = document.getElementById('newTeacherPhone').value;
                const subjects = document.getElementById('newTeacherSubjects').value.split(',').map(s => s.trim()).filter(s => s);
                
                if (!name) {
                    alert('El nombre del maestro es obligatorio');
                    return;
                }

                const newTeacher = {
                    id: Math.max(...this.teachers.map(t => t.id), 0) + 1,
                    name: name,
                    email: email,
                    phone: phone,
                    subjects: subjects,
                    avatar: name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase(),
                    active: true
                };

                this.teachers.push(newTeacher);
                this.saveAllData();
                alert(`‚úÖ Maestro "${name}" agregado exitosamente`);
                this.showTeachersManager();
            }

            deleteTeacher(teacherId) {
                if (confirm('¬øEst√° seguro de eliminar este maestro?')) {
                    this.teachers = this.teachers.filter(t => t.id !== teacherId);
                    // Tambi√©n eliminar sus clases del horario
                    for (const day in this.weeklySchedule) {
                        this.weeklySchedule[day] = this.weeklySchedule[day].filter(cls => cls.teacherId !== teacherId);
                    }
                    this.saveAllData();
                    this.showTeachersManager();
                }
            }

            // ==================== REPORTES Y TABLAS ====================
            showReportsModule() {
                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>üìä Reportes y Tablas de Registros</h1>
                        <button class="btn" onclick="finalApp.showMainDashboard()">‚Üê Dashboard</button>
                    </div>
                    
                    <div class="container">
                        <div class="card">
                            <h3>üìà Resumen General</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                                <div style="text-align: center; padding: 15px; background: #e8f4fd; border-radius: 5px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #3498db;">${this.teachers.length}</div>
                                    <div>Maestros</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 5px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${this.attendanceRecords.length}</div>
                                    <div>Total Registros</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: #fff3cd; border-radius: 5px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${this.getTotalClasses()}</div>
                                    <div>Clases Programadas</div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>üìã Tabla de Registros de Asistencia</h3>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>D√≠a</th>
                                            <th>Maestro</th>
                                            <th>Asignatura</th>
                                            <th>Grado</th>
                                            <th>Entrada</th>
                                            <th>Salida</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.attendanceRecords.slice().reverse().map(record => `
                                            <tr>
                                                <td>${record.date}</td>
                                                <td>${record.day}</td>
                                                <td>${record.teacherName}</td>
                                                <td>${record.subject}</td>
                                                <td>${record.grade}</td>
                                                <td>${record.entryTime}</td>
                                                <td>${record.exitTime || '--'}</td>
                                                <td>
                                                    <span class="status-badge status-${record.status.toLowerCase().includes('puntual') ? 'puntual' : record.status.toLowerCase().includes('tard√≠o') ? 'tardio' : 'ausente'}">
                                                        ${record.status}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                        ${this.attendanceRecords.length === 0 ? `
                                            <tr>
                                                <td colspan="8" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                                    No hay registros de asistencia a√∫n.
                                                </td>
                                            </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                            ${this.attendanceRecords.length > 0 ? `
                                <div style="margin-top: 15px; text-align: center;">
                                    <button class="btn btn-primary" onclick="finalApp.exportToCSV()">
                                        üì• Exportar a CSV
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // ==================== CONFIGURACI√ìN ADMINISTRATIVA ====================
            showAdminSettings() {
                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>‚öôÔ∏è Configuraci√≥n del Sistema</h1>
                        <button class="btn" onclick="finalApp.showMainDashboard()">‚Üê Dashboard</button>
                    </div>
                    
                    <div class="container">
                        <div class="card admin-panel">
                            <h3>üîê Cambiar Contrase√±a de Administrador</h3>
                            <div class="teacher-form">
                                <div class="form-group">
                                    <label>Contrase√±a actual:</label>
                                    <input type="password" id="currentPassword" placeholder="Ingresa la contrase√±a actual">
                                </div>
                                <div class="form-group">
                                    <label>Nueva contrase√±a:</label>
                                    <input type="password" id="newPassword" placeholder="Ingresa la nueva contrase√±a">
                                </div>
                                <div class="form-group">
                                    <label>Confirmar nueva contrase√±a:</label>
                                    <input type="password" id="confirmPassword" placeholder="Confirma la nueva contrase√±a">
                                </div>
                                <button class="btn btn-primary" onclick="finalApp.changeAdminPassword()">
                                    üîÑ Cambiar Contrase√±a
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <h3>üõ†Ô∏è Herramientas del Sistema</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <button class="btn btn-warning" onclick="finalApp.manageCatalog('subjects')">
                                    üìö Gestionar Asignaturas
                                </button>
                                <button class="btn btn-warning" onclick="finalApp.manageCatalog('grades')">
                                    üéì Gestionar Grados
                                </button>
                                <button class="btn btn-warning" onclick="finalApp.manageCatalog('classrooms')">
                                    üè´ Gestionar Aulas
                                </button>
                                <button class="btn" onclick="finalApp.backupData()" style="background: #27ae60; color: white;">
                                    üíæ Respaldar Datos
                                </button>
                                <button class="btn logout-btn" onclick="finalApp.resetSystem()">
                                    üóëÔ∏è Restablecer Sistema
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            changeAdminPassword() {
                const current = document.getElementById('currentPassword').value;
                const newPass = document.getElementById('newPassword').value;
                const confirm = document.getElementById('confirmPassword').value;

                if (current !== this.adminPassword) {
                    alert('‚ùå La contrase√±a actual es incorrecta');
                    return;
                }

                if (newPass !== confirm) {
                    alert('‚ùå Las nuevas contrase√±as no coinciden');
                    return;
                }

                if (newPass.length < 4) {
                    alert('‚ùå La contrase√±a debe tener al menos 4 caracteres');
                    return;
                }

                this.adminPassword = newPass;
                this.saveAllData();
                alert('‚úÖ Contrase√±a cambiada exitosamente');
                this.showAdminSettings();
            }

            // ==================== FUNCIONES AUXILIARES ====================
            getCurrentTime() {
                return new Date().toTimeString().substring(0, 5);
            }

            getTodaysClasses() {
                return this.weeklySchedule[this.currentDay] || [];
            }

            getTodaysRecords() {
                const today = new Date().toLocaleDateString();
                return this.attendanceRecords.filter(record => record.date === today);
            }

            getScheduleById(scheduleId) {
                for (const day in this.weeklySchedule) {
                    const found = this.weeklySchedule[day].find(cls => cls.id === scheduleId);
                    if (found) return found;
                }
                return null;
            }

            getTeacherClasses(teacherId) {
                let classes = [];
                for (const day in this.weeklySchedule) {
                    classes = classes.concat(this.weeklySchedule[day].filter(cls => cls.teacherId === teacherId));
                }
                return classes;
            }

            getTotalClasses() {
                let total = 0;
                for (const day in this.weeklySchedule) {
                    total += this.weeklySchedule[day].length;
                }
                return total;
            }

            calculateStatus(entryTime, scheduledTime) {
                const entry = new Date(`2000-01-01 ${entryTime}`);
                const scheduled = new Date(`2000-01-01 ${scheduledTime}`);
                const diff = (entry - scheduled) / (1000 * 60);
                
                if (diff <= 0) return 'Puntual üü¢';
                if (diff <= 10) return `Tard√≠o üî¥ (+${diff} min)`;
                return 'Ausente üü°';
            }

            calculateDuration(startTime, endTime) {
                const start = new Date(`2000-01-01 ${startTime}`);
                const end = new Date(`2000-01-01 ${endTime}`);
                const diff = (end - start) / (1000 * 60);
                const hours = Math.floor(diff / 60);
                const minutes = diff % 60;
                return `${hours}h ${minutes}m`;
            }

            startTimeAutoUpdate() {
                if (this.timeUpdateInterval) clearInterval(this.timeUpdateInterval);
                this.timeUpdateInterval = setInterval(() => {
                    this.updateTimeDisplay();
                }, 60000);
            }

            updateTimeDisplay() {
                if (this.currentView === 'attendance') {
                    const timeDisplay = document.getElementById('currentTimeDisplay');
                    if (timeDisplay) {
                        timeDisplay.textContent = this.getCurrentTime();
                    }
                }
            }

            // Funciones pendientes de implementaci√≥n completa
            editTeacher(teacherId) {
                alert('‚úèÔ∏è Editar maestro - Funci√≥n en desarrollo');
            }

            editClass(day, classId) {
                alert('‚úèÔ∏è Editar clase - Funci√≥n en desarrollo');
            }

            manageCatalog(catalogType) {
                alert(`üìã Gestionar ${catalogType} - Funci√≥n en desarrollo`);
            }

            backupData() {
                const dataStr = JSON.stringify({
                    teachers: this.teachers,
                    schedule: this.weeklySchedule,
                    attendance: this.attendanceRecords,
                    subjects: this.subjects,
                    grades: this.grades,
                    classrooms: this.classrooms
                }, null, 2);
                
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `respaldo-sistema-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Datos respaldados exitosamente');
            }

            resetSystem() {
                if (confirm('¬øEST√Å SEGURO? Esto eliminar√° TODOS los datos del sistema y lo restablecer√° a valores predeterminados.')) {
                    localStorage.clear();
                    alert('‚úÖ Sistema restablecido. Recargando...');
                    setTimeout(() => location.reload(), 2000);
                }
            }

            exportToCSV() {
                let csv = 'Fecha,D√≠a,Maestro,Asignatura,Grado,Entrada,Salida,Estado\n';
                
                this.attendanceRecords.forEach(record => {
                    csv += `"${record.date}","${record.day}","${record.teacherName}","${record.subject}","${record.grade}","${record.entryTime}","${record.exitTime || ''}","${record.status}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `asistencia-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }

            logout() {
                if (this.timeUpdateInterval) {
                    clearInterval(this.timeUpdateInterval);
                }
                this.currentUser = null;
                this.showLogin();
            }
        }

        // Inicializar la aplicaci√≥n FINAL
        const finalApp = new FinalAttendanceSystem();
    </script>
</body>
</html>
